# Data Processor: GitHub Automation Bots Monitoring System

An application to continuously consume new data generated by [repo-automation-bots](https://github.com/googleapis/repo-automation-bots) as well as other related sources, process it into a standardized format, and store it in Firestore

## Deployment

// TODO(asonawalla)

### Setting up permissions

If you want to use an existing Service Account to give Data Processor access to resources, skip to step 3.

1. Create a GCP Service Account for the Cloud Run instance used by Data Processor by going to GCP Console -> IAM & Admin -> Service Accounts
2. Copy the email address associated with the Service Account you just created
3. Edit the Cloud Run instance used by Data Processor and under Container -> Service Account select the account you just created in step 2 (or an existing account you want to use with Data Processor)

#### Give Data Processor Access to Cloud Tasks

Assign the Data Processor Service Account the IAM permission `cloudtasks.tasks.list` by going to the GCP Console where the task queues live -> IAM & Admin -> IAM

#### Give Data Processor Access to Firestore

Assign the Data Processor Service Account the role `Firebase Develop Admin` in the GCP Console of the Firebase project.

## Development

### Architectural Overview

// TODO(asonawalla)

### Firestore Schema

The Data Processor requires the Firestore instance to have the following schema:

```    
"Bot": {                                         // collection
    "[bot_id]": {                                // document
    "bot_name": "[bot_name]"
    }
    ...
},
    
"Task_Status_Queue": {                           // collection
    "[bot_id]_[timestamp]": {                    // document
    "in_queue": "[in_queue]"
    }
    ...
},

"Bot_Execution": {                               // collection
    "[execution_id]": {                          // document
    "bot_id": "[bot_id]",
    "trigger_id": "[trigger_id]",
    "start_time": "[start_time]",
    "end_time": "[end_time]",
    "logs_url": "[logs_url]"
    }
    ...
},

"Error": {                                       // collection
    "[error_id]": {                              // document
    "execution_id": "[execution_id]",
    "error_msg": "[error_msg]",
    "timestamp": "[timestamp]]",
    "logs_url": "[logs_url]"
    }
    ...
},

"Trigger": {                                     // collection
    "[trigger_id]": {                            // document
    "github_event": "[github_event]",
    "trigger_type": "[trigger_type]"
    }
    ...
},


"Action": {                                      // collection
    "[action_id]": {                             // document
    "execution_id": "[execution_id]",
    "action_type": "[action_type]",
    "destination_object": "[destination_object]",
    "destination_repo": "[destination_repo]",
    "value": "[value]",
    "timestamp": "[timestamp]",
    "logs_url": "[logs_url]"
    }
    ...
},

"Action_Type": {                                 // collection
    "[action_type_id]": {                        // document
    "description": "[description]",
    "dev_hours_saved": "[dev_hours_saved]"
    }
    ...
},

"GitHub_Event": {                                // collection
    "[payload_hash]": {                          // document
    "repository": "[repository]",
    "event_type": "[event_type]",
    "timestamp": "[timestamp]",
    "actor": "[actor]"
    }
    ...
},

"GitHub_Repository": {                           // collection
    "[repo_name]_[owner_name]_[owner_type]": {}  // document
    ...
},

"GitHub_Object": {                               // collection
    "[object_type]_[repository]_[object_id]": {} // document
    ...
}
```